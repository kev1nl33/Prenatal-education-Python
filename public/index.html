<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能胎教助手</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C13.1046 2 14 2.89543 14 4V6H16C17.1046 6 18 6.89543 18 8V18C18 19.1046 17.1046 20 16 20H8C6.89543 20 6 19.1046 6 18V8C6 6.89543 6.89543 6 8 6H10V4C10 2.89543 10.8954 2 12 2Z" fill="currentColor"/>
                    <circle cx="12" cy="13" r="3" fill="white"/>
                </svg>
                <h1>智能胎教助手</h1>

            </div>
            <p class="subtitle">用AI为你和宝宝创造美好的胎教时光</p>
        </header>



        <!-- 历史记录模态框 -->
        <div id="historyModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>历史记录管理</h2>
                    <button id="closeHistoryModal" class="close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="history-controls">
                        <button id="clearAllHistory" class="btn btn-danger">清空所有记录</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <p class="empty-state">暂无历史记录</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="closeHistoryModalBtn" class="btn btn-outline">关闭</button>
                </div>
            </div>
        </div>

        <main class="main">

            <!-- 胎教内容生成区域 -->
            <section class="content-section">
                <h2>选择胎教内容类型</h2>
                <div class="content-cards">
                    <div class="content-card active" data-type="story">
                        <div class="card-icon">📖</div>
                        <h3>温馨故事</h3>
                        <p>温馨的胎教故事，富有想象力，传递爱与希望</p>
                    </div>
                    <div class="content-card" data-type="music">
                        <div class="card-icon">🎵</div>
                        <h3>音乐引导</h3>
                        <p>轻柔的音乐引导，深度放松，心灵沟通</p>
                    </div>
                    <div class="content-card" data-type="poetry">
                        <div class="card-icon">🌸</div>
                        <h3>诗歌朗诵</h3>
                        <p>优美的诗歌韵律，适合轻声吟诵，营造宁静氛围</p>
                    </div>
                    <div class="content-card" data-type="nature">
                        <div class="card-icon">🌿</div>
                        <h3>自然描述</h3>
                        <p>美丽的自然景象，感受大自然的美好与宁静</p>
                    </div>
                    <div class="content-card" data-type="emotion">
                        <div class="card-icon">💝</div>
                        <h3>情感表达</h3>
                        <p>表达深深的爱意和期待，增进亲子情感纽带</p>
                    </div>
                    <div class="content-card" data-type="learning">
                        <div class="card-icon">🎨</div>
                        <h3>启蒙认知</h3>
                        <p>温和的认知启蒙，颜色形状数字等基础概念</p>
                    </div>
                </div>
                
                <div class="content-form">
                    <input type="hidden" id="contentType" value="story">
                    
                    <div class="form-group">
                        <label for="duration">内容长度:</label>
                        <select id="duration">
                            <option value="short">短篇 (3-5分钟)</option>
                            <option value="medium">中篇 (5-10分钟)</option>
                            <option value="long">长篇 (10-15分钟)</option>
                        </select>
                    </div>
                    <button id="generateContent" class="btn btn-primary">
                        <span class="btn-text">生成内容</span>
                        <div class="loading-spinner" style="display: none;"></div>
                    </button>
                </div>
            </section>

            <!-- 内容展示区域 -->
            <section class="result-section" id="resultSection" style="display: none;">
                <h2>生成的胎教内容</h2>
                <div class="content-display">
                    <div class="content-text-container">
                        <div class="content-text" id="contentText"></div>
                        <button class="expand-btn" id="expandBtn" style="display: none;">展开全文</button>
                    </div>
                    <div class="audio-controls">
                        <div class="voice-settings">
                            <div class="form-group">
                                <label for="voiceSelector">选择朗读语音:</label>
                                <select id="voiceSelector">
                                    <option value="zh_female_roumeinvyou_emo_v2_mars_bigtts">💕 柔美女友（多情感）</option>
                                    <option value="zh_female_shuangkuaisisi_emo_v2_mars_bigtts">🌟 爽快思思（多情感）</option>
                                    <option value="ICL_zh_female_huoponvhai_tob">☀️ 活泼女孩</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mood">期望情绪:</label>
                                <select id="mood">
                                    <option value="happy">开心</option>
                                    <option value="neutral">中性</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button id="testVoiceSettings" class="btn btn-outline btn-sm" style="margin-top: 8px;">
                                    <span class="btn-text">🧪 测试当前语音设置</span>
                                    <div class="loading-spinner" style="display: none;"></div>
                                </button>
                            </div>
                        </div>
                        <div class="audio-generation-controls">
                            <button id="previewAudio" class="btn btn-outline">
                                <span class="btn-text">试听效果</span>
                                <div class="loading-spinner" style="display: none;"></div>
                            </button>
                            <button id="generateAudio" class="btn btn-secondary" disabled>
                                <span class="btn-text">生成语音</span>
                                <div class="loading-spinner" style="display: none;"></div>
                            </button>
                        </div>
                        <div class="preview-player" id="previewPlayer" style="display: none;">
                            <div class="preview-header">
                                <span class="preview-label">🎧 试听效果</span>
                                <span class="preview-text" id="previewText"></span>
                            </div>
                            <audio controls id="previewAudioElement">
                                您的浏览器不支持音频播放。
                            </audio>
                            <div class="preview-actions">
                                <button id="confirmPreview" class="btn btn-primary btn-sm">效果满意，生成完整语音</button>
                                <button id="retryPreview" class="btn btn-outline btn-sm">重新试听</button>
                            </div>
                        </div>
                        <div class="audio-player" id="audioPlayer" style="display: none;">
                            <audio controls id="audioElement">
                                您的浏览器不支持音频播放。
                            </audio>
                            <button id="downloadAudio" class="btn btn-outline">下载音频</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 历史记录功能模块 -->
            <section class="history-section">
                <div class="history-module">
                    <div class="history-card" id="historyCard">
                        <div class="card-icon">📚</div>
                        <h3>历史记录</h3>
                        <p>查看和管理您的胎教内容历史记录</p>
                        <button class="btn btn-outline" id="openHistoryBtn">查看历史记录</button>
                    </div>
                </div>
            </section>

            <!-- 声音复刻功能模块 -->
            <section class="voice-clone-section">
                <h2>🎤 声音复刻</h2>
                <p class="section-description">上传您的声音样本，训练专属的AI语音模型，让胎教内容更加个性化</p>
                
                <!-- 声音复刻卡片网格 -->
                <div class="voice-clone-grid">
                    <!-- 音频上传卡片 -->
                    <div class="voice-clone-card upload-card">
                        <div class="card-header">
                            <div class="card-icon">🎙️</div>
                            <h3>上传音频</h3>
                        </div>
                        <div class="card-content">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-placeholder">
                                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M7 10L12 5L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M12 5V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <p>点击或拖拽音频文件到此处</p>
                                    <small>支持 WAV、MP3 格式，建议时长 10-60 秒</small>
                                </div>
                                <input type="file" id="audioFileInput" accept=".wav,.mp3" style="display: none;">
                            </div>
                            
                            <div class="upload-form" id="uploadForm" style="display: none;">
                                <div class="form-group">
                                    <label for="speakerName">声音名称:</label>
                                    <input type="text" id="speakerName" placeholder="例如：妈妈的声音" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label for="voiceLanguage">语言:</label>
                                    <select id="voiceLanguage">
                                        <option value="zh">中文</option>
                                        <option value="en">英文</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="modelType">模型类型:</label>
                                    <select id="modelType">
                                        <option value="1">ICL (快速训练)</option>
                                        <option value="2">DiT 标准版 (高质量)</option>
                                        <option value="3">DiT 还原版 (最高还原度)</option>
                                    </select>
                                </div>
                                <div class="upload-actions">
                                    <button id="startTraining" class="btn btn-primary">
                                        <span class="btn-text">开始训练</span>
                                        <div class="loading-spinner" style="display: none;"></div>
                                    </button>
                                    <button id="cancelUpload" class="btn btn-outline">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 训练状态卡片 -->
                    <div class="voice-clone-card status-card">
                        <div class="card-header">
                            <div class="card-icon">⏳</div>
                            <h3>训练状态</h3>
                        </div>
                        <div class="card-content">
                            <div class="status-empty" id="statusEmpty">
                                <p>暂无训练任务</p>
                                <small>上传音频文件开始训练您的专属声音</small>
                            </div>
                            <div class="status-list" id="statusList" style="display: none;">
                                <!-- 训练状态项将动态添加到这里 -->
                            </div>
                        </div>
                    </div>

                    <!-- 已复刻声音列表卡片 -->
                    <div class="voice-clone-card voices-card">
                        <div class="card-header">
                            <div class="card-icon">🎵</div>
                            <h3>我的声音</h3>
                            <button id="refreshVoices" class="btn-icon" title="刷新列表">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M20.49 9C19.9828 7.56678 19.1209 6.28392 17.9845 5.27304C16.8482 4.26216 15.4745 3.55682 13.9917 3.21834C12.5089 2.87986 10.9652 2.91902 9.50481 3.33329C8.04437 3.74757 6.70481 4.52433 5.60999 5.59L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M3.51001 15C4.01716 16.4332 4.87906 17.7161 6.01543 18.727C7.1518 19.7378 8.52547 20.4432 10.0083 20.7817C11.4911 21.1201 13.0348 21.081 14.4952 20.6667C15.9556 20.2524 17.2952 19.4757 18.39 18.41L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="card-content">
                            <div class="voices-empty" id="voicesEmpty">
                                <p>暂无已训练的声音</p>
                                <small>完成声音训练后，您的专属声音将显示在这里</small>
                            </div>

                            <!-- 手动添加已有的声音ID -->
                            <div class="manual-add" style="margin: 10px 0 16px; padding: 10px; background: rgba(255,255,255,0.06); border-radius: 8px;">
                                <div class="form-row" style="display:flex; gap:8px; margin-bottom:8px;">
                                    <input id="existingSpeakerId" type="text" placeholder="输入已有的声音ID，例如 S_xxx" style="flex:2;" />
                                    <input id="existingSpeakerName" type="text" placeholder="显示名称（可选）" style="flex:1;" />
                                </div>
                                <div class="form-row" style="display:flex; gap:8px; align-items:center;">
                                    <select id="existingVoiceLanguage" style="flex:1;">
                                        <option value="zh">中文</option>
                                        <option value="en">英文</option>
                                    </select>
                                    <select id="existingModelType" style="flex:1;">
                                        <option value="1">ICL</option>
                                        <option value="2">DiT 标准版</option>
                                        <option value="3">DiT 还原版</option>
                                    </select>
                                    <button id="addExistingVoiceBtn" class="btn btn-outline" style="flex:none;">
                                        <span class="btn-text">添加已有ID</span>
                                        <div class="loading-spinner" style="display:none;"></div>
                                    </button>
                                </div>
                                <small style="opacity:0.8;">若你已在平台上训练好声音，可直接输入声音ID加入并使用。</small>
                            </div>

                            <div class="voices-list" id="voicesList" style="display: none;">
                                <!-- 已复刻声音项将动态添加到这里 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 清理可能存在的Service Worker和缓存，解决POST请求缓存错误
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    console.log('卸载Service Worker:', registration.scope);
                    registration.unregister();
                }
            });
        }
        
        // 清理缓存
        if ('caches' in window) {
            caches.keys().then(function(cacheNames) {
                return Promise.all(
                    cacheNames.map(function(cacheName) {
                        console.log('删除缓存:', cacheName);
                        return caches.delete(cacheName);
                    })
                );
            }).then(function() {
                console.log('所有缓存已清理完成');
            });
        }
    </script>
    <!-- 引入音频处理工具 -->
    <script src="utils/audio.js"></script>
    <script src="script.js"></script>
</body>
</html>